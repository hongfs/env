lua_package_path "/etc/nginx/lua/?.lua;;";

server {
    listen 80;
    server_name _;

    location / {
        set $to_new_version '';

        access_by_lua_block {
            local token = ngx.req.get_headers()['Authorization'];

            if token == nil then
                ngx.log(ngx.ERR, '没有 Token');
                return;
            end

            if string.len(token) > 40 or string.len(token) < 40 then
                ngx.log(ngx.ERR, 'Token 长度异常');
                return;
            end

            if string.sub(token, 1, 1) ~= 'A' then
                ngx.log(ngx.ERR, 'Token 前缀异常');
                return;
            end

            ngx.var.to_new_version = '1';

            ngx.log(ngx.ERR, 'Token 正确');
        }

        # if ($to_new_version = '1') {
        #     proxy_pass http://127.0.0.1:82;
        #     break;
        # }

        # proxy_pass http://127.0.0.1:81;

        return 200 $to_new_version;
    }
}

server {
    listen 81;
    server_name _;

    location / {
        return 200 "success";
    }
}

server {
    listen 82;
    server_name _;

    location / {
        return 200 "new version";
    }
}
