lua_package_path "/etc/nginx/lua/?.lua;;";

server {
    listen 80;
    server_name _;

    location / {
        access_by_lua_block {
            local ratelimit = require "lua-resty-redis-ratelimit.lib.resty.redis.ratelimit"

            local lim, err = ratelimit.new("hongfs", "5000r/s", 200, 0)
            if not lim then
                ngx.log(ngx.ERR, "failed to instantiate a resty.redis.ratelimit object: ", err)
                return ngx.exit(500)
            end

            local redis = require "lua-resty-redis.lib.resty.redis"
            local red = redis:new()

            red:set_timeout(1000)

            local ok, err = red:connect("10.0.16.15", 6379)
            if not ok then
                ngx.log(ngx.ERR, "failed to connect redis: ", err)
                return ngx.exit(500)
            end

            local key = ngx.var.binary_remote_addr
            local delay, err = lim:incoming(key, red)
            if not delay then
                if err == "rejected" then
                    return ngx.exit(503)
                end
                ngx.log(ngx.ERR, "failed to limit req: ", err)
                return ngx.exit(500)
            end

            if delay >= 0.001 then
                local excess = err

                ngx.sleep(delay)
            end
        }
        
        proxy_pass http://127.0.0.1:81;
    }
}

server {
    listen 81;
    server_name _;

    location / {
        return 200 "success";
    }
}
